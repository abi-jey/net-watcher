# Agent Instructions

## Project Context
`net-watcher` is a secure, lightweight network traffic recorder written in Go. It captures DNS queries and other network events using Linux raw sockets (AF_PACKET) and stores them in a local SQLite database. It includes a web interface for visualization.

**Key Constraints:**
- **OS:** Linux ONLY (depends on `AF_PACKET`).
- **Security:** Runs with minimal privileges (`cap_net_raw`), strictly sandboxed.
- **Dependencies:** Pure Go, no CGO (except SQLite driver where needed, but prefers pure Go patterns).

## Tech Stack
- **Language:** Go 1.25+
- **Database:** SQLite (via GORM)
- **Frontend:** React (embedded in the Go binary via `embed`)
- **Logging:** `github.com/charmbracelet/log`
- **Packet Capture:** `github.com/google/gopacket`
- **Build System:** `make`

## Project Structure
- `/main.go`: Entry point.
- `/internal/capture`: Packet capture logic (sniffer).
- `/internal/database`: GORM models (`NetworkEvent`) and DB operations.
- `/internal/web`: HTTP server and API handlers.
  - `/internal/web/static`: React frontend source.
- `/pkg/cli`: CLI command implementations (using `spf13/cobra` style patterns, though custom implemented here).
- `/pkg/watcher`: Core service logic.

## Development Workflow

### Building
Always use the Makefile:
- `make build`: Standard build.
- `make build-debug`: Build with debug flags.
- `make build-all`: Cross-compile for Linux amd64/arm64.

### Testing
- `make test`: Run unit tests.
- `make lint`: Run `golangci-lint`.

### Running locally
To run the daemon in debug mode:
```bash
sudo ./net-watcher-debug serve --interface <your-interface> --debug
```
*Note: Sudo is required for packet capture permissions.*

## Architecture Patterns

### Database (SQLite)
- **WAL Mode:** Enabled for concurrency.
- **Compaction:** The DB has a custom compaction mechanism (`db.Compact`) to merge TCP/UDP start/end events and deduplicate DNS queries.
- **Batching:** Inserts are batched (default 100) to improve throughput.

### Web Interface
- The frontend is a React SPA located in `internal/web/static`.
- It is compiled and embedded into the Go binary.
- API endpoints are defined in `internal/web/server.go`.

### Logging
- Use structured logging with `github.com/charmbracelet/log`.
- Example: `logger.Info("message", "key", value)`

## Code Comments
- **No Signature:** NEVER add comments indicating code was generated by AI or a specific tool (e.g., "Generated by CoPilot", "AI-generated").
- **Purpose:** Comments should explain *why*, not *what*.
- **Doc Comments:** Public functions and types must have Go-style doc comments (e.g., `// FuncName does X for struct: [StructName]`).

## Commit Conventions
Follow Semantic Release standards:
- `feat:` New features
- `fix:` Bug fixes
- `docs:` Documentation
- `chore:` Maintenance
