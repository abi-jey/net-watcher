# Copilot Instructions for net-watcher

## Project Overview
Net-watcher is a **Linux-only** DNS traffic recorder using pure Go with AF_PACKET raw sockets. No CGO or external libraries (like libpcap) are used.

## Architecture

```
main.go                      # CLI entry point with subcommands (serve, inspect, install, version)
├── pkg/cli/commands.go      # Command implementations (Serve, Inspect, Install)
├── internal/capture/
│   └── sniffer.go           # AF_PACKET DNS capture (Linux syscalls only)
└── internal/database/
    ├── schema.go            # SQLite operations (modernc.org/sqlite - pure Go)
    └── models.go            # DNSEvent, EventFilter, DatabaseStats
```

### Data Flow
1. `DNSSniffer` captures packets via `syscall.AF_PACKET` raw socket
2. Packets are parsed manually (Ethernet → IP → UDP → DNS) without gopacket
3. DNS queries are sent to `eventChan` channel
4. `Serve()` batches events and inserts into SQLite via `InsertDNSEventBatch()`

## Build Commands

```bash
make build              # Build for current platform
make build-all          # Build linux-amd64 and linux-arm64
make build-debug        # Debug build with symbols
make test               # Run tests with race detector
go vet ./...            # Required before commits
```

## Key Conventions

### Linux-Only Constraint
- All capture code uses `//go:build linux` build tag
- Uses `syscall.AF_PACKET` + `syscall.SOCK_RAW` (requires `CAP_NET_RAW`)
- No cross-platform support - intentional design decision

### Error Wrapping
Always wrap errors with context:
```go
return fmt.Errorf("failed to bind to interface %s: %w", iface, err)
```

### Version Injection
Build flags inject version info into `main.go` variables:
```go
var (
    version   = "1.0.0-dev"
    buildTime = "unknown"
    commitSHA = "unknown"
)
```
Set via: `-ldflags="-X main.version=${VERSION}"`

### Database Patterns
- Use `InsertDNSEventBatch()` for bulk inserts (not single inserts)
- WAL mode enabled for concurrent access
- Retention cleanup runs hourly via `CleanupOldEvents()`

## Testing Requirements
- Run `sudo` for capture tests (needs `CAP_NET_RAW`)
- Database tests use in-memory SQLite: `NewDatabase(":memory:")`

## Files to Reference
- [sniffer.go](internal/capture/sniffer.go) - Packet parsing without external deps
- [schema.go](internal/database/schema.go) - Database operations and batch inserts
- [commands.go](pkg/cli/commands.go) - Event loop and graceful shutdown pattern

## Comments
Never use Generated by copoilot and similar comments in the codebase.