# Generated by Copilot
name: CI

on:
  push:
    branches: ['*']
  pull_request:

permissions:
  contents: write

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ./.github/actions/setup-go
    - run: go test -v -race ./...
    - run: go vet ./...
    - uses: golangci/golangci-lint-action@v6
      with:
        version: latest
        args: --timeout=5m

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    outputs:
      version: ${{ steps.version.outputs.version }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - uses: ./.github/actions/setup-go

    - name: Determine version
      id: version
      uses: ./.github/actions/version
      with:
        ref_name: ${{ github.ref_name }}
        sha: ${{ github.sha }}

    - name: Build binaries
      uses: ./.github/actions/build
      with:
        version: ${{ steps.version.outputs.version }}
        commit_sha: ${{ github.sha }}
        build_time: ${{ github.event.head_commit.timestamp }}

    - uses: actions/upload-artifact@v4
      with:
        name: net-watcher-binaries
        path: dist/*

  release:
    name: Pre-release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    steps:
    - uses: actions/download-artifact@v4
      with:
        name: net-watcher-binaries
        path: dist

    - name: Create Pre-release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.build.outputs.version }}
        name: Build ${{ needs.build.outputs.version }}
        body: |
          Pre-release from `${{ github.ref_name }}` branch.
          **Commit:** `${{ github.sha }}`
        prerelease: ${{ needs.build.outputs.prerelease }}
        files: dist/*
        token: ${{ secrets.GITHUB_TOKEN }}