# Net-Watcher Log Messages

<!-- Generated by Copilot -->

This document explains the different log message types produced by net-watcher.

## Log Format

All logs follow the structured format:
```
time=<timestamp> level=INFO msg="[TYPE]" key=value key=value ...
```

## Connection Lifecycle Logs

### `[TCP START]`
Logged when a new TCP connection is detected (SYN packet).

| Field | Description |
|-------|-------------|
| `iface` | Network interface name |
| `src` | Source IP and port `[IP]:port` |
| `dst` | Destination IP and port `[IP]:port` |

**Example:**
```
msg="[TCP START]" iface=enp3s0 src=[192.168.1.120]:45678 dst=[140.82.112.21]:443
```

### `[TCP END]`
Logged when a TCP connection ends (FIN or RST packet).

| Field | Description |
|-------|-------------|
| `iface` | Network interface name |
| `src` | Source IP and port |
| `dst` | Destination IP and port |
| `duration` | Connection duration (e.g., `1.234s`) |
| `bytes` | Total bytes transferred |
| `reason` | `FIN` (graceful close) or `RST` (reset/abort) |

**Example:**
```
msg="[TCP END]" iface=enp3s0 src=[192.168.1.120]:45678 dst=[140.82.112.21]:443 duration=792ms bytes=10509 reason=FIN
```

### `[UDP START]`
Logged when the first UDP packet of a "session" is detected. Unlike TCP, UDP is connectionless, so sessions are tracked by source/destination pairs.

| Field | Description |
|-------|-------------|
| `iface` | Network interface name |
| `src` | Source IP and port |
| `dst` | Destination IP and port |
| `service` | Identified service (DNS, QUIC, Tailscale, etc.) or empty |

**Example:**
```
msg="[UDP START]" iface=enp3s0 src=[192.168.1.120]:55805 dst=[192.168.1.1]:53 service=DNS
```

### `[UDP END]`
Logged when a UDP session times out (no packets for 2 minutes). Since UDP has no connection state, this is based on inactivity.

| Field | Description |
|-------|-------------|
| `iface` | Network interface name |
| `src` | Source IP and port |
| `dst` | Destination IP and port |
| `duration` | Time from first to last packet |
| `bytes` | Total bytes transferred |

**Example:**
```
msg="[UDP END]" iface=enp3s0 src=[192.168.1.120]:55805 dst=[192.168.1.1]:53 duration=1m30s bytes=2048
```

## Protocol-Specific Logs

### `[DNS]`
Logged for DNS queries and responses (UDP port 53).

| Field | Description |
|-------|-------------|
| `iface` | Network interface name |
| `type` | `QUERY` or `RESPONSE` |
| `src` | Source IP and port |
| `dst` | Destination IP and port |
| `domain` | Domain name being queried |

**Example:**
```
msg="[DNS]" iface=enp3s0 type=QUERY src=[192.168.1.120]:58961 dst=[192.168.1.1]:53 domain=github.com
```

### `[TLS SNI]`
Logged when a TLS ClientHello with Server Name Indication is detected. This reveals the hostname being connected to, even for HTTPS.

| Field | Description |
|-------|-------------|
| `iface` | Network interface name |
| `src` | Source IP and port |
| `dst` | Destination IP and port |
| `server_name` | The SNI hostname |

**Example:**
```
msg="[TLS SNI]" iface=enp3s0 src=[192.168.1.120]:34604 dst=[140.82.112.21]:443 server_name=github.com
```

### `[ICMP]`
Logged for ICMP packets (ping, traceroute, errors).

| Field | Description |
|-------|-------------|
| `iface` | Network interface name |
| `src` | Source IP |
| `dst` | Destination IP |
| `type` | ICMP type number |
| `code` | ICMP code number |
| `desc` | Human-readable description |

**Common ICMP Types:**
- Type 0: Echo Reply (ping response)
- Type 3: Destination Unreachable
- Type 8: Echo Request (ping)
- Type 11: Time Exceeded (traceroute)

**ICMPv6 Types:**
- Type 1: Destination Unreachable
- Type 128: Echo Request
- Type 129: Echo Reply
- Type 133-137: Neighbor Discovery Protocol (NDP)

**Example:**
```
msg="[ICMP]" iface=enp3s0 src=192.168.1.1 dst=192.168.1.120 type=0 code=0 desc="Echo Reply"
```

## Session Management Logs

### `[TIMEOUT]`
Logged when a non-UDP session (TCP or ICMP) times out without proper termination. This indicates a connection that was abandoned or lost.

| Field | Description |
|-------|-------------|
| `protocol` | `TCP` or `ICMP` |
| `iface` | Network interface name |
| `src` | Source address |
| `dst` | Destination address |
| `duration` | Time from first to last packet |
| `bytes` | Total bytes transferred |

**Example:**
```
msg="[TIMEOUT]" protocol=TCP iface=enp3s0 src=[192.168.1.120]:45678 dst=[10.0.0.1]:80 duration=2m0s bytes=1024
```

## UDP vs TCP Session Tracking

| Aspect | TCP | UDP |
|--------|-----|-----|
| **Start Detection** | SYN flag | First packet seen |
| **End Detection** | FIN/RST flag | 2-minute timeout |
| **Connection State** | Explicit (SYN→ESTABLISHED→FIN) | Implicit (timeout-based) |
| **Byte Counting** | Accurate for full session | Best effort |

## Identified UDP Services

The `service` field in `[UDP START]` identifies common services by port:

| Service | Ports |
|---------|-------|
| DNS | 53 |
| DHCP | 67, 68 |
| NTP | 123 |
| SNMP | 161, 162 |
| QUIC/HTTP3 | 443, 8443 |
| WireGuard | 51820 |
| Tailscale | 41641 |
| BitTorrent | 6881-6890, 51413 |
| mDNS | 5353 |
| SSDP | 1900 |

## Filtering Options

Use these flags to reduce log noise:

```bash
# Only log specific protocols
--only tcp,dns,tls

# Exclude traffic types
--exclude multicast,broadcast,linklocal,bittorrent,mdns,ssdp,metadata,ndp,unreachable

# Exclude specific ports (default: 47604)
--exclude-ports 47604,6881
```

### Exclusion Types

| Exclusion | Description |
|-----------|-------------|
| `multicast` | IPv4 224.x.x.x, IPv6 ff00::/8 |
| `broadcast` | 255.255.255.255 |
| `linklocal` | 169.254.x.x, fe80:: |
| `bittorrent` | Ports 6881-6890, 51413 |
| `mdns` | Port 5353 |
| `ssdp` | Port 1900 |
| `metadata` | 169.254.169.254 (cloud metadata) |
| `ndp` | ICMPv6 types 133-137 |
| `unreachable` | ICMP destination unreachable |
